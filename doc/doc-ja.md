xml2saty-rust

# はじめに

OCamlで作成したXMLファイルをSATySFiのsatyファイルに変換するソフトウェアをRustで再実装しました。

名前はやや安直で、"xml2saty-rust"です。リポジトリは[ここ](https://github.com/puripuri2100/xml2saty-rust)にあります。

# インストール

- Rustをインストールします
```sh
curl https://sh.rustup.rs -sSf | sh
```
で入ります。
Ubuntu on WSLの人は
```sh
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
```
で、Windowsの人は[インストーラー](https://www.rust-lang.org/tools/install)をダウンロードして起動してください。

- リポジトリをクローンしてビルドする
```sh
git clone https://github.com/puripuri2100/xml2saty-rust.git
cd xml2saty-rust
make install
```
でビルドができ、インストールも完了します。

# 使い方

`-f`もしくは`--file`オプションでXMLファイルを渡すことができます。このオプションは省略することができます。

`-o`または`--output`オプションで出力ファイル名を指定できます。無い場合は入力のファイル名を流用します。オプションそのものを省略するとXMLファイルの名前から自動的にファイルが作成されます。

`-c`または`--config`で設定ファイル（JSONファイル）を渡すことができます。

`-p`または`--package`でSATySFiのパッケージファイルとして出力することができます。

`-t`または`--text`で直接XML文字列を渡すことができます。このとき、`-o`・`--output`・`-c`・`--config`オプションは省略できません。

起動は

```
xml2saty -f 〈XMLファイル〉 -o 〈satyファイル〉 -c 〈設定ファイル〉
```

または

```
xml2saty -f 〈XMLファイル〉 -o 〈satyファイル〉 -c 〈設定ファイル〉 -p "〈モジュール名〉,〈関数名〉"
```

です。

## 入力するXMLファイルについて

xml-lightパッケージが処理できる正しいXMLファイルである必要があります。

また、要素の名前などについてはASCII文字以外である場合の動作については保証できません。

また、ファイル名を渡すときに拡張子は省略できません。

## 出力ファイルについて

`-o`や`--output`オプションに渡すファイル名では拡張子を省略できません。

## パッケージとして出力する際について

`-p`や`--package`オプションを使う時は与えるモジュール名と関数名の順番を間違えないように過不足なく与えるようにしてください。

## 設定ファイルについて

JSONファイルを渡します。

`"require"`タグには、`@require:`の後に記述されるパッケージ名（パス）を文字列のリストの形で渡します。

`"import"`タグには、`@import:`の後に記述されるパッケージ名（パス）を文字列のリストの形で渡します。


`"attrib"`タグには要素名の変換方法ついて指定内容をリストの形で渡します。

`"attrib"`の中身の1つ1つはこのようになっています。

```
    {
      "tag": "hoge",
      "rename":"fuga",
      "type":"inline-text",
      "len":1,
      "attribs":[
        {
          "tag":"piyo",
          "type" : "string"
          "num": 1
        }
      ]
    }
```

それぞれ以下のような役割を持ちます。

- `tag` : どの要素名について指定しているのかを表します。省略できません。文字列です。
- `rename` : 要素名名を変更したい場合はこれで変更します。変更しない場合には省略できます。文字列です。
- `type` : 要素の中身がどの型になるのかを指定します。省略できません。
- `len` : 要素の属性の数を指定します。省略でき、その場合は下にある`attribs`のリストの数が使われます。
- `attribs` : 属性1つ1つについて指定していきます。リストを渡してください。省略できません。
  - `tag` : 属性の名前です。
  - `type` : その要素の中身の型を指定します。
  - `num` : その要素が何番目に来るかを指定します。


`attribs`のリストに含まれなかった属性の場合や、〈何番目か〉のところで〈属性の数〉で指定した数より大きい数か0以下の数字を渡していた場合は、その属性は無視されて`None`が返されます。
また、属性は「その属性が無かったら`None`を、あったら`Some(var)`を返す」という挙動をするようにしているため、全て`'a option`型になります。

これらを与えることで出力されるファイルの中身を制御できるようになります。


使える型名は現在のところ

- `string`
- `int`
- `bool`
- `float`
- `length`
- `inline-text`
- `block-text`
- `funciton`
- `<type> list`

です。`function`を選択すると、要素の中にある子要素が全て関数扱いになり、先頭が小文字になります。
`inline-text`は先頭に`\`が付き、`block-text`は`+`が付きます。
`inline-text list`のように`<type> list`のように書くことでリストの形でも出力できます。




# 使用例

リポジトリにexampleフォルダの中にe-Gov法令検索からダウンロードできる元号法と刑法のXMLファイルが置いてあります。

```
make example
```

でsatyファイルを作成することができます。

付属の`local.satyh`にコマンドの定義が書いてあるのでそれを使って
```
satysfi example/keihou.saty -o example/keihou.pdf
```
のようにしてコンパイルすることができます。

また、これを応用することによりHTMLファイルをsatyファイルに変換することも可能なはずです。